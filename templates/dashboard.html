<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">

<div class="d-flex justify-content-end gap-2 mb-3">
    <a href="/dashboard" class="btn btn-primary">Dashboard</a>
    <a href="/logout" class="btn btn-danger">Logout</a>
</div>

<h3>Welcome, {{ session['admin'] }}</h3>

<div class="card p-4 mb-4">
<h5>Generate QR</h5>

<form method="POST" action="/generate" id="qrForm" class="row g-3">

<input type="text" name="subject" class="form-control col" placeholder="Subject" required>
<input type="text" name="class_id" class="form-control col" placeholder="Class" required>
<input type="number" name="duration" class="form-control col" placeholder="Duration (min)" required>

<input type="hidden" name="latitude" id="latitude">
<input type="hidden" name="longitude" id="longitude">

<div class="col-12 d-flex gap-2">
<button type="button" id="detectBtn" class="btn btn-info">Detect Location</button>
<button type="submit" id="generateBtn" class="btn btn-success" disabled>Generate QR</button>
</div>

<div id="locError" class="alert alert-danger d-none mt-2">
Location permission is required.
</div>

</form>
</div>

{% if session_id %}
<div class="card p-4 text-center">
<h5>QR Code</h5>
<p>{{ subject }} - {{ class_id }}</p>
<img src="{{ url_for('static', filename='qr.png') }}" width="200">
<p class="text-danger">Expires at {{ expiry }}</p>
</div>
{% endif %}

</div>

<script>
const detectBtn = document.getElementById("detectBtn");
const generateBtn = document.getElementById("generateBtn");
const lat = document.getElementById("latitude");
const lon = document.getElementById("longitude");
const err = document.getElementById("locError");

detectBtn.onclick = () => {
    err.classList.add("d-none");

    navigator.geolocation.getCurrentPosition(
        pos => {
            lat.value = pos.coords.latitude;
            lon.value = pos.coords.longitude;
            generateBtn.disabled = false;
            detectBtn.innerText = "Location Detected âœ“";
        },
        () => {
            err.classList.remove("d-none");
        },
        { enableHighAccuracy: true }
    );
};
</script>

</body>
</html>
